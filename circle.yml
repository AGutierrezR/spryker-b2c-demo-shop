machine:
  php:
    version: 5.6.5
  environment:
    APPLICATION_ENV: development
    APPLICATION_STORE: DE
  services:
    - elasticsearch
database:
  override:
    - mv config/Zed/propel.ci.yml config/Zed/propel.yml
    - cp config/Shared/config_default-development.ci.php config/Shared/config_default-development_DE.php
    - cp config/Shared/config_default-development.ci.php config/Shared/config_default-test.php
dependencies:
  pre:
    - mkdir -p shared/data/common/jenkins
    - mkdir -p shared/data/common/jenkins/jobs
    - echo "memory_limit = 512M" > ~/.phpenv/versions/$(phpenv global)/etc/conf.d/memory.ini
    # - mysql -u ubuntu circle_test --execute="SET GLOBAL group_concat_max_len=1048576"
    - wget https://phar.phpunit.de/phpcpd.phar
test:
  pre:
    - sudo bash -c "echo \"host all all 0.0.0.0/0 trust\" >>
        /etc/postgresql/9.4/main/pg_hba.conf"
    - sudo service postgresql restart
    - >
      if [ -n "${RUN_SPRYKER_BUILD}" ]; then
        cd vendor/spryker/spryker && git checkout origin/${BRANCH}
      fi
  override:
#    - phpcpd . --exclude="vendor" --exclude="config" --exclude="src/Generated" -n
# Bundles have tons of duplicates so build will always fail
#   - phpcpd vendor/spryker/spryker/Bundles -n
    - vendor/bin/codecept build
    - PGPASSWORD='' psql -U postgres -w  -c 'SELECT pg_terminate_backend(pg_stat_activity.pid) FROM pg_stat_activity WHERE pid <> pg_backend_pid()'
    - PGPASSWORD='' psql -U postgres -w  -c 'DROP DATABASE IF EXISTS "circle_test"'
    - vendor/bin/console application:integration-check
