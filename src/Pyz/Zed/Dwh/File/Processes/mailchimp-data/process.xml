<?xml version="1.0" encoding="UTF-8"?>
<process xmlns="http://project-a.com/dwh-process"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://project-a.com/dwh-process ../../../../../../../../vendor/project-a/dwh-package/component/Dwh/process.xsd"
         id="mailchimp"
         description="Transforms the newsletter data (from MailChimp) into the newsletter cubes.">

    <initial-job id="initialize-schemas">
        <description>Recreates the structure of the newsletter schema</description>
        <commands>
            <php-command class-name="Pac_Dwh_Model_Import_Command_WriteConfig"/>
            <run-sql-file file-name="update-mailchimp-data-schema.sql" echo-queries="false"
                          depends-on="update-mailchimp-data-schema.sql"/>
            <run-sql-file file-name="recreate-dim-schemas.sql" echo-queries="true"/>

            <run-sql-file file-name="campaign/schema.sql" echo-queries="false"/>
            <run-sql-file file-name="list/schema.sql" echo-queries="false"/>
            <run-sql-file file-name="recipient/schema.sql" echo-queries="false"/>
            <run-sql-file file-name="newsletter/schema.sql" echo-queries="false"/>
        </commands>
    </initial-job>


    <!-- Read mailchimp data -->

    <job id="read-list">
        <description>Loads unprocessed csv files into mailchimp_data.lists</description>
        <commands>
            <load-csv-files csv-file-pattern="mail-chimp/lists-*.csv"
                            is-zipped="false" process-files="only-latest"
                            delimiter-char="&#9;" sql-delimiter-char="&#9;"
                            skip-number-of-lines="1" columns="1 2 3 4"
                            target-table="mailchimp_data.list"
                            depends-on="recreate-dim-schemas.sql"
                            timezone="GMT"/>
        </commands>
    </job>

    <job id="read-campaign">
        <description>Loads unprocessed csv files into mailchimp_data.campaign</description>
        <commands>
            <load-csv-files csv-file-pattern="mail-chimp/campaigns-*.csv"
                            is-zipped="false" process-files="all"
                            delimiter-char="&#9;" sql-delimiter-char="&#9;"
                            skip-number-of-lines="1" columns="1 2 3 4"
                            target-table="mailchimp_data.campaign"
                            depends-on="recreate-dim-schemas.sql"
                            timezone="GMT"/>
        </commands>
    </job>

    <job id="read-campaign-activity">
        <description>Loads unprocessed csv files into mailchimp_data.campaign_activity</description>
        <commands>
            <load-csv-files csv-file-pattern="mail-chimp/campaign-activity-*.csv"
                            is-zipped="false" process-files="all"
                            delimiter-char="&#9;" sql-delimiter-char="&#9;"
                            skip-number-of-lines="1" columns="1 2 3 4"
                            target-table="mailchimp_data.campaign_activity"
                            depends-on="recreate-dim-schemas.sql"
                            timezone="GMT"/>
        </commands>
    </job>

    <job id="read-campaign-receiver">
        <description>Loads unprocessed csv files into mailchimp_data.campaign_receiver</description>
        <commands>
            <load-csv-files csv-file-pattern="mail-chimp/campaign-receivers-*.csv"
                            is-zipped="false" process-files="all"
                            delimiter-char="&#9;" sql-delimiter-char="&#9;"
                            skip-number-of-lines="1" columns="1 2 3"
                            target-table="mailchimp_data.campaign_receiver"
                            depends-on="recreate-dim-schemas.sql"
                            timezone="GMT"/>
        </commands>
    </job>

    <job id="read-campaign-unsubscriber">
        <description>Loads unprocessed csv files into mailchimp_data.campaign_unsubscriber</description>
        <commands>
            <load-csv-files csv-file-pattern="mail-chimp/campaign-unsubscribers-*.csv"
                            is-zipped="false" process-files="only-latest"
                            delimiter-char="&#9;" sql-delimiter-char="&#9;"
                            skip-number-of-lines="1" columns="1 2 3 4"
                            target-table="mailchimp_data.campaign_unsubscriber"
                            depends-on="recreate-dim-schemas.sql"
                            timezone="GMT"/>
        </commands>
    </job>

    <job id="read-list-activity">
        <description>Loads unprocessed csv files into mailchimp_data.campaign_list_activity</description>
        <commands>
            <load-csv-files csv-file-pattern="mail-chimp/list-activity-*.csv"
                            allow-null-values="true"
                            is-zipped="false" process-files="all"
                            delimiter-char="&#9;" sql-delimiter-char="&#9;"
                            skip-number-of-lines="1" columns="1 2 3 4 5 6 7 8 9 10 11"
                            target-table="mailchimp_data.list_activity"
                            depends-on="recreate-dim-schemas.sql"
                            timezone="GMT"/>
        </commands>
    </job>


    <job id="map-campaign">
        <description>Creates an integer id for campaigns</description>
        <dependencies>
            <dependency job="read-campaign"/>
        </dependencies>
        <commands>
            <run-sql-file file-name="campaign/map-campaign.sql" echo-queries="true"/>
        </commands>
    </job>

    <job id="map-list">
        <description>Creates an integer id for lists</description>
        <dependencies>
            <dependency job="read-list"/>
        </dependencies>
        <commands>
            <run-sql-file file-name="list/map-list.sql" echo-queries="true"/>
        </commands>
    </job>


    <job id="transform-recipient-subscriptions">
        <description>Fills the newsletter recipient table</description>
        <dependencies>
            <dependency job="read-list-activity"/>
            <dependency job="read-campaign-unsubscriber"/>
            <dependency job="read-campaign"/>
        </dependencies>
        <commands>
            <run-sql-file file-name="recipient/transform-subscriptions.sql" echo-queries="true"/>
        </commands>
    </job>

    <job id="transform-recipient">
        <description>Fills the newsletter recipient table</description>
        <dependencies>
            <dependency job="transform-recipient-location"/>
            <dependency job="transform-recipient-subscriptions"/>
        </dependencies>
        <commands>
            <run-sql-file file-name="recipient/transform-recipient.sql" echo-queries="true"/>
        </commands>
    </job>

    <job id="transform-campaign-unsubscriber">
        <description>Fills the campaign unsubscriber table</description>
        <dependencies>
            <dependency job="transform-recipient"/>
        </dependencies>
        <commands>
            <run-sql-file file-name="recipient/transform-unsubscriber.sql" echo-queries="true"/>
        </commands>
    </job>


    <job id="transform-campaign">
        <description>Fills the newsletter campaign table</description>
        <dependencies>
            <dependency job="map-campaign"/>
            <dependency job="map-list"/>
        </dependencies>
        <commands>
            <run-sql-file file-name="campaign/transform-campaign.sql" echo-queries="true"/>
        </commands>
    </job>

    <job id="transform-list">
        <description>Fills the newsletter list table</description>
        <dependencies>
            <dependency job="map-list"/>
        </dependencies>
        <commands>
            <run-sql-file file-name="list/transform-list.sql" echo-queries="true"/>
        </commands>
    </job>

    <job id="transform-campaign-activity">
        <description>Fills the campaign activity table</description>
        <dependencies>
            <dependency job="read-campaign-activity"/>
            <dependency job="map-newsletter-email"/>
        </dependencies>
        <commands>
            <run-sql-file file-name="campaign/transform-campaign-activity.sql" echo-queries="true"/>
        </commands>
    </job>

    <job id="transform-list-activity">
        <description>Fills the list activity table</description>
        <dependencies>
            <dependency job="transform-recipient"/>
            <dependency job="map-list"/>
        </dependencies>
        <commands>
            <run-sql-file file-name="list/transform-list-activity.sql" echo-queries="true"/>
        </commands>
    </job>


    <job id="transform-recipient-location">
        <description>Fills the recipient location table</description>
        <dependencies>
            <dependency job="read-list-activity"/>
        </dependencies>
        <commands>
            <run-sql-file file-name="recipient/transform-location.sql" echo-queries="true"/>
        </commands>
    </job>


    <job id="transform-campaign-recipient">
        <description>Fill the campaign recipient table</description>
        <dependencies>
            <dependency job="read-campaign-receiver"/>
            <dependency job="transform-recipient"/>
            <dependency job="transform-campaign"/>
        </dependencies>
        <commands>
            <run-sql-file file-name="campaign/transform-campaign-recipient.sql" echo-queries="true"/>
        </commands>
    </job>


    <job id="map-newsletter-email">
        <description>Computes an email for every camapign email</description>
        <dependencies>
            <dependency job="transform-campaign-recipient"/>
            <dependency job="transform-campaign-unsubscriber"/>
            <dependency job="transform-list-activity"/>
        </dependencies>
        <commands>
            <run-sql-file file-name="newsletter/map-newsletter-email.sql" echo-queries="true"/>
        </commands>
    </job>

    <job id="transform-newsletter-email-date">
        <description>Computes a date for each email and time perspective</description>
        <dependencies>
            <dependency job="transform-campaign-activity"/>
        </dependencies>
        <commands>
            <run-sql-file file-name="newsletter/transform-newsletter-email-date.sql" echo-queries="true"/>
        </commands>
    </job>

    <job id="index-newsletter-email-date">
        <description>Adds foreign keys and indexes to the dim.newsletter_email_date table</description>
        <dependencies>
            <dependency job="transform-newsletter-email-date"/>
        </dependencies>
        <commands>
            <execute-sql>SELECT mailchimp_tmp.index_dim_newsletter_email_date();</execute-sql>
        </commands>
    </job>


    <job id="flatten-newsletter-email-date">
        <description>Creates a single flat fact table for the newsletter cube</description>
        <dependencies>
            <dependency job="index-newsletter-email-date"/>
        </dependencies>
        <commands>
            <run-sql-file file-name="newsletter/flatten-newsletter-email-date.sql" echo-queries="true"/>
        </commands>
    </job>

    <job id="flatten-newsletter-campaign-fact">
        <description>Creates a single flat fact table for the newsletter campaign cube</description>
        <dependencies>
            <dependency job="transform-campaign-activity"/>
        </dependencies>
        <commands>
            <run-sql-file file-name="newsletter/flatten-newsletter-campaign-fact.sql" echo-queries="true"/>
        </commands>
    </job>


    <job id="flatten-newsletter-recipient-fact">
        <description>Creates a single flat fact table for the newsletter recipient cube</description>
        <dependencies>
            <dependency job="transform-campaign-activity"/>
        </dependencies>
        <commands>
            <run-sql-file file-name="newsletter/flatten-newsletter-recipient-fact.sql" echo-queries="true"/>
        </commands>
    </job>


    <final-job id="replace-dim-schema">
        <description>Replaces the current mailchimp_dim schema with the next one</description>
        <commands>
            <execute-sql>SELECT util.replace_schema('mailchimp_dim', 'mailchimp_dim_next');</execute-sql>
        </commands>
    </final-job>

</process>
